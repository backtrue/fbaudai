å­åŸŸåæœå‹™ API ç‹€æ…‹å ±å‘Š
çµ±ä¸€èªè­‰èˆ‡æœƒå“¡ç®¡ç†ç³»çµ±
åŸºæº–æ—¥æœŸï¼š2025-01-12
eccal ä½œç‚ºçµ±ä¸€æœƒå“¡èˆ‡é»æ•¸ç®¡ç†ä¸­å¿ƒ

æ ¸å¿ƒ API ç«¯é»
1. èªè­‰ç›¸é—œ
POST /api/auth/google-sso
- åŠŸèƒ½ï¼šGoogle SSO ç™»å…¥
- å›æ‡‰ï¼šJWT Token åŒ…å« membership å’Œ credits è³‡è¨Š
- ç‹€æ…‹ï¼šâœ… å®Œå…¨é‹ä½œ
POST /api/sso/verify-token
- åŠŸèƒ½ï¼šé©—è­‰ JWT Token
- å›æ‡‰ï¼šç”¨æˆ¶åŸºæœ¬è³‡è¨Š
- ç‹€æ…‹ï¼šâœ… å®Œå…¨é‹ä½œ
POST /api/sso/refresh-token
- åŠŸèƒ½ï¼šåˆ·æ–° Token
- ç‹€æ…‹ï¼šâœ… å®Œå…¨é‹ä½œ
2. ç”¨æˆ¶è³‡æ–™ç®¡ç†
GET /api/account-center/user/{userId}
- åŠŸèƒ½ï¼šç²å–ç”¨æˆ¶å®Œæ•´è³‡æ–™
- åŒ…å«ï¼šmembership, credits, å€‹äººè³‡è¨Š
- ç‹€æ…‹ï¼šâœ… å®Œå…¨é‹ä½œ
GET /api/account-center/user/{email}
- åŠŸèƒ½ï¼šé€é Email æŸ¥è©¢ç”¨æˆ¶
- ç‹€æ…‹ï¼šâš ï¸ éœ€è¦é€²ä¸€æ­¥èª¿è©¦
GET /api/account-center/credits/{userId}
- åŠŸèƒ½ï¼šæŸ¥è©¢ç”¨æˆ¶é»æ•¸é¤˜é¡
- ç‹€æ…‹ï¼šâœ… å®Œå…¨é‹ä½œ
3. é»æ•¸ç®¡ç†ç³»çµ±
POST /api/account-center/credits/{userId}/deduct
- åŠŸèƒ½ï¼šæ‰£é™¤ç”¨æˆ¶é»æ•¸
- åŒ…å«ï¼šäº¤æ˜“è¨˜éŒ„ã€é¤˜é¡æ›´æ–°
- ç‹€æ…‹ï¼šâœ… å®Œå…¨é‹ä½œ
GET /api/account-center/credits/{userId}
- åŠŸèƒ½ï¼šæŸ¥è©¢é»æ•¸é¤˜é¡
- ç‹€æ…‹ï¼šâœ… å®Œå…¨é‹ä½œ
4. æœƒå“¡ç­‰ç´šç®¡ç†
GET /api/account-center/membership/{userId}
- åŠŸèƒ½ï¼šæŸ¥è©¢æœƒå“¡ç­‰ç´šå’Œåˆ°æœŸæ—¥
- ç‹€æ…‹ï¼šâœ… å®Œå…¨é‹ä½œ
PUT /api/account-center/user/{userId}
- åŠŸèƒ½ï¼šæ›´æ–°ç”¨æˆ¶è³‡æ–™
- ç‹€æ…‹ï¼šâœ… å®Œå…¨é‹ä½œ
é‡è¦ç³»çµ±ä¿®æ­£
é»æ•¸ç³»çµ±çµ±ä¸€ (V4.2.1)
å•é¡Œï¼šå‰ç«¯å„€è¡¨æ¿é¡¯ç¤º 45 é»ï¼ŒAccount Center API é¡¯ç¤º 42 é»
åŸå› ï¼šå…©å€‹è³‡æ–™è¡¨ (user_credits vs users) å„²å­˜ä¸åŒæ•¸å€¼
è§£æ±ºï¼šçµ±ä¸€ä½¿ç”¨ users.credits ä½œç‚ºå”¯ä¸€ä¾†æº
çµæœï¼šæ‰€æœ‰ API ç«¯é»ç¾åœ¨é¡¯ç¤ºä¸€è‡´çš„ 42 é»
è³‡æ–™åº«çµ±ä¸€
-- ä¸»è¦è³‡æ–™ä¾†æº
users.credits = 42 (å”¯ä¸€æ¨™æº–)
-- åŒæ­¥æ›´æ–°
user_credits.balance = 42 (å·²åŒæ­¥)
æ¸¬è©¦ç”¨æˆ¶è³‡æ–™
{
  "userId": "102598988575056957509",
  "email": "backtrue@gmail.com",
  "name": "é‚±ç…œåº­ï¼ˆé‚±å°é»‘ï¼‰",
  "membership": "pro",
  "credits": 42,
  "membershipExpires": "2025-08-01"
}
å­åŸŸåæœå‹™æ•´åˆç¯„ä¾‹
JavaScript SDK ä½¿ç”¨
const EccalAuth = {
  baseURL: 'https://eccal.thinkwithblack.com',
  
  // ç™»å…¥
  async googleLogin(service) {
    const params = new URLSearchParams({
      service: service,
      origin: window.location.origin
    });
    window.location.href = `${this.baseURL}/api/sso/login?${params}`;
  },
  
  // é©—è­‰ Token
  async verifyToken(token) {
    const response = await fetch(`${this.baseURL}/api/sso/verify-token`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': window.location.origin
      },
      body: JSON.stringify({ token })
    });
    return response.json();
  },
  
  // ç²å–ç”¨æˆ¶è³‡æ–™ (åŒ…å«æœƒå“¡ç­‰ç´šå’Œé»æ•¸)
  async getUserData(userId) {
    const response = await fetch(`${this.baseURL}/api/account-center/user/${userId}`, {
      headers: { 'Origin': window.location.origin }
    });
    return response.json();
  },
  
  // æ‰£é™¤é»æ•¸
  async deductCredits(userId, amount, reason, service) {
    const response = await fetch(`${this.baseURL}/api/account-center/credits/${userId}/deduct`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': window.location.origin
      },
      body: JSON.stringify({
        amount: amount,
        reason: reason,
        service: service
      })
    });
    return response.json();
  }
};
æœƒå“¡ç­‰ç´šæª¢æŸ¥
async function checkMembershipLevel(userId) {
  const userData = await EccalAuth.getUserData(userId);
  
  if (userData.success) {
    const user = userData.user;
    
    // æª¢æŸ¥æœƒå“¡ç­‰ç´š
    if (user.membership === 'pro') {
      console.log('PRO æœƒå“¡ï¼Œäº«æœ‰å®Œæ•´åŠŸèƒ½');
      return 'pro';
    } else {
      console.log('å…è²»æœƒå“¡ï¼ŒåŠŸèƒ½å—é™');
      return 'free';
    }
  }
  
  return 'unknown';
}
é»æ•¸ç®¡ç†
async function manageCredits(userId, requiredCredits, service) {
  // å…ˆæª¢æŸ¥é¤˜é¡
  const creditsResponse = await fetch(`${EccalAuth.baseURL}/api/account-center/credits/${userId}`, {
    headers: { 'Origin': window.location.origin }
  });
  
  const creditsData = await creditsResponse.json();
  
  if (creditsData.success && creditsData.balance >= requiredCredits) {
    // æ‰£é™¤é»æ•¸
    const deductResult = await EccalAuth.deductCredits(
      userId, 
      requiredCredits, 
      'åŠŸèƒ½ä½¿ç”¨', 
      service
    );
    
    if (deductResult.success) {
      console.log(`æˆåŠŸæ‰£é™¤ ${requiredCredits} é»æ•¸ï¼Œå‰©é¤˜ ${deductResult.remainingCredits} é»`);
      return true;
    }
  }
  
  console.log('é»æ•¸ä¸è¶³æˆ–æ‰£é™¤å¤±æ•—');
  return false;
}
CORS å·²é…ç½®åŸŸå
https://eccal.thinkwithblack.com
https://audai.thinkwithblack.com
https://sub3.thinkwithblack.com
https://sub4.thinkwithblack.com
https://sub5.thinkwithblack.com
https://member.thinkwithblack.com
http://localhost:3000
http://localhost:5000
ç³»çµ±ç‹€æ…‹ç¸½çµ
âœ… æ­£å¸¸é‹ä½œ
Google SSO èªè­‰
JWT Token ç”Ÿæˆèˆ‡é©—è­‰
ç”¨æˆ¶è³‡æ–™æŸ¥è©¢ (ID æ–¹å¼)
é»æ•¸æŸ¥è©¢èˆ‡æ‰£é™¤
æœƒå“¡ç­‰ç´šç®¡ç†
è·¨åŸŸ CORS æ”¯æ´
âš ï¸ éœ€è¦æ³¨æ„
Email æŸ¥è©¢åŠŸèƒ½éœ€é€²ä¸€æ­¥èª¿è©¦
JWT Token é©—è­‰å›æ‡‰æœªåŒ…å«å®Œæ•´ membership/credits è³‡æ–™
ğŸ“Š æ¸¬è©¦çµæœ
ç¸½ API ç«¯é»ï¼š12 å€‹
æ¸¬è©¦é€šéç‡ï¼š10/12 (83%)
æ ¸å¿ƒåŠŸèƒ½ï¼š100% æ­£å¸¸
æœ€å¾Œæ›´æ–°ï¼š2025-01-12
ç‰ˆæœ¬ï¼šV4.2.1